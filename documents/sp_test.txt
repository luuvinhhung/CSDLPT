USE [TRACNGHIEM]
GO
/****** Object:  StoredProcedure [dbo].[SP_TEST]    Script Date: 07/22/2018 10:16:58 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER  PROCEDURE [dbo].[SP_TEST] 
	@MAMH CHAR(5),
	@SOCAUHOI INT,
	@TRINHDO CHAR(1)
	
AS
BEGIN
	
	DECLARE @SOCAUDALAY INT
	DECLARE @SOCAUCANLAYTHEM INT
	IF(@TRINHDO = 'A')
		BEGIN
			SET @SOCAUDALAY = (SELECT COUNT(CAUHOI)
								FROM BODE , GIAOVIEN
								WHERE  BODE.MAMH = @MAMH AND BODE.MAGV = GIAOVIEN.MAGV)
			IF @SOCAUDALAY >= @SOCAUHOI
				BEGIN
					SELECT TOP (@SOCAUHOI) BODE.CAUHOI
					FROM BODE, GIAOVIEN
					WHERE BODE.MAMH = @MAMH AND BODE.MAGV = GIAOVIEN.MAGV
					ORDER BY NEWID()
				END
			ELSE
				BEGIN
					SET @SOCAUCANLAYTHEM= @SOCAUHOI - @SOCAUDALAY

					PRINT 'SOCAUDALAY= '+CAST(@SOCAUDALAY AS CHAR(3))+' SOCAUCANLAYTHEM= '+ CAST(@SOCAUCANLAYTHEM AS CHAR(3))

					SELECT DISTINCT TOP (@SOCAUDALAY) BODE.CAUHOI,BODE.MAGV,NEWID()
					FROM BODE, GIAOVIEN
					WHERE BODE.MAMH = @MAMH AND BODE.MAGV = GIAOVIEN.MAGV
					UNION ALL
					SELECT DISTINCT TOP (@SOCAUCANLAYTHEM) BODE.CAUHOI,BODE.MAGV,NEWID()
					FROM BODE, GIAOVIEN
					WHERE BODE.MAMH = @MAMH AND BODE.MAGV NOT IN (SELECT GIAOVIEN.MAGV FROM GIAOVIEN)
					ORDER BY NEWID()
			
				END
		END
	ELSE IF(@TRINHDO = 'B')
		BEGIN
			SET @SOCAUDALAY = (SELECT COUNT(CAUHOI)
								FROM BODE , GIAOVIEN
								WHERE  BODE.MAMH = @MAMH AND TRINHDO != 'A' AND BODE.MAGV = GIAOVIEN.MAGV)
			IF @SOCAUDALAY >= @SOCAUHOI
				BEGIN
					SELECT TOP (@SOCAUHOI) BODE.CAUHOI
					FROM BODE, GIAOVIEN
					WHERE BODE.MAMH = @MAMH AND TRINHDO != 'A' AND BODE.MAGV = GIAOVIEN.MAGV
					ORDER BY NEWID()
				END
			ELSE
				BEGIN
					SET @SOCAUCANLAYTHEM= @SOCAUHOI - @SOCAUDALAY

					SELECT DISTINCT TOP (@SOCAUDALAY) BODE.CAUHOI,NEWID()
					FROM BODE, GIAOVIEN
					WHERE BODE.MAMH = @MAMH AND TRINHDO != 'A' AND BODE.MAGV = GIAOVIEN.MAGV
					UNION ALL
					SELECT DISTINCT TOP (@SOCAUCANLAYTHEM) BODE.CAUHOI,NEWID()
					FROM BODE, GIAOVIEN
					WHERE BODE.MAMH = @MAMH AND TRINHDO != 'A' AND BODE.MAGV = GIAOVIEN.MAGV
					ORDER BY NEWID()
					
				END
		END
		ELSE
		BEGIN
			SET @SOCAUDALAY = (SELECT COUNT(CAUHOI)
								FROM BODE , GIAOVIEN
								WHERE  BODE.MAMH = @MAMH AND TRINHDO = 'C' AND BODE.MAGV = GIAOVIEN.MAGV)
			IF @SOCAUDALAY >= @SOCAUHOI
				BEGIN
					SELECT TOP (@SOCAUHOI) BODE.CAUHOI
					FROM BODE, GIAOVIEN
					WHERE BODE.MAMH = @MAMH AND TRINHDO = 'C' AND BODE.MAGV = GIAOVIEN.MAGV
					ORDER BY NEWID()
				END
			ELSE
				BEGIN
					SET @SOCAUCANLAYTHEM= @SOCAUHOI - @SOCAUDALAY

					SELECT DISTINCT TOP (@SOCAUDALAY) BODE.CAUHOI,NEWID()
					FROM BODE, GIAOVIEN
					WHERE BODE.MAMH = @MAMH AND TRINHDO = 'C' AND BODE.MAGV = GIAOVIEN.MAGV 
					UNION
					SELECT DISTINCT TOP (@SOCAUCANLAYTHEM) BODE.CAUHOI,NEWID()
					FROM BODE, GIAOVIEN
					WHERE BODE.MAMH = @MAMH AND TRINHDO = 'C' AND BODE.MAGV = GIAOVIEN.MAGV
					ORDER BY NEWID()
					
				END
		END
END
return


